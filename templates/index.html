
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Separador Digital de Arquivos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-scissors me-2"></i>
        Separador Digital de Arquivos
      </a>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="card p-4">
          <h1 class="h4 mb-3">Envie seu PDF para separar e otimizar</h1>
          <form id="pdfForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-file-earmark-arrow-up"></i> Selecionar arquivo PDF</label>
              <input class="form-control" type="file" name="arquivo_pdf" accept="application/pdf,.pdf" required>
            </div>
            <div class="row g-3">
              <div class="col-6">
                <label class="form-label"><i class="bi bi-sliders"></i> Qualidade</label>
                <select class="form-select" name="qualidade">
                  <option value="screen">Screen</option>
                  <option value="ebook" selected>Ebook</option>
                  <option value="printer">Printer</option>
                  <option value="prepress">Prepress</option>
                  <option value="default">Default</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-stopwatch"></i> Timeout (s)</label>
                <input class="form-control" type="number" name="timeout" value="60" min="10" step="5" required>
              </div>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-cpu"></i> Threads</label>
                <input class="form-control" type="number" name="threads" value="4" min="1" max="32" step="1" required>
              </div>
              <div class="col-6 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="limpar" id="limpar">
                  <label class="form-check-label" for="limpar">
                    <i class="bi bi-trash3"></i> Apagar originais após otimização
                  </label>
                </div>
              </div>
            </div>
            <div class="d-grid mt-4">
              <button class="btn btn-brand btn-lg" type="submit">
                <i class="bi bi-magic"></i> Processar PDF
              </button>
            </div>
          </form>
          <hr class="my-4">
          <h2 class="h5 mb-3">Progresso</h2>
          <div class="progress mb-2">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%">0%</div>
          </div>
          <div id="statusMsg" class="small text-muted mb-2">Aguardando início…</div>
          <div class="log-area p-3">
            <ul id="logList" class="list-unstyled m-0"></ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const form = document.getElementById('pdfForm');
    const progressBar = document.getElementById('progressBar');
    const logList = document.getElementById('logList');
    const statusMsg = document.getElementById('statusMsg');

    function setProgress(p){
      const val = Math.max(0, Math.min(100, Math.round(p)));
      progressBar.style.width = val + '%';
      progressBar.textContent = val + '%';
      progressBar.setAttribute('aria-valuenow', val);
    }

    function addLog(text){
      const li = document.createElement('li');
      li.textContent = text;
      logList.prepend(li);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setProgress(0);
      statusMsg.textContent = 'Iniciando processamento…';
      logList.innerHTML = '';

      const data = new FormData(form);
      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;

      try{
        const res = await fetch('/process', { method: 'POST', body: data });
        const js = await res.json();

        if(!js.ok){
          statusMsg.textContent = js.error || 'Erro ao iniciar.';
          btn.disabled = false;
          return;
        }

        statusMsg.textContent = 'Processando…';
        const es = new EventSource('/stream?job=' + js.job_id);

        es.onmessage = (e) => {
          if(!e.data) return;
          const payload = JSON.parse(e.data);

          if(payload.error){
            statusMsg.textContent = payload.msg || 'Erro durante o processamento.';
            es.close();
            btn.disabled = false;
            return;
          }

          if(payload.msg) addLog(payload.msg);

          if(typeof payload.atual === 'number' && typeof payload.total === 'number' && payload.total > 0){
            const percent = (payload.atual / payload.total) * 100;
            setProgress(percent);
          }

          if(payload.done){
            setProgress(100);
            statusMsg.textContent = payload.msg || 'Concluído!';
            es.close();
            btn.disabled = false;
          }
        };

        es.onerror = () => {
          statusMsg.textContent = 'Conexão perdida.';
          es.close();
          btn.disabled = false;
        };

      }catch(err){
        statusMsg.textContent = 'Falha ao iniciar processamento.';
        btn.disabled = false;
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
