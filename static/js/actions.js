(function(){function etaText(sec){if(!sec) return '';if(sec<60) return sec+'s';const m=Math.floor(sec/60),s=sec%60;return m+'m '+s+'s';}async function postForm(url,form){const fd=new FormData();const input=form.querySelector('.upload-area input[type=file]');if(input&&input.files.length){for(const f of input.files){fd.append('arquivos',f);}}const r=await fetch(url,{method:'POST',body:fd});return r.json();}async function poll(taskId,ui,onDone){let pct=0;const tick=()=>{pct=Math.min(98,pct+5);ui.bar.style.width=pct+'%';};const loop=async()=>{try{const r=await fetch('/api/status/'+taskId);const j=await r.json();if(!j.ok){ui.result.textContent='Erro: '+(j.error||'');ui.btn.disabled=false;return;}if(['PENDING','RECEIVED','STARTED','PROGRESS'].includes(j.state)){tick();setTimeout(loop,800);}else if(j.state==='SUCCESS'){ui.bar.style.width='100%';onDone(j.result);}else if(j.state==='FAILURE'){ui.result.innerHTML='Falha no processamento. <button class="btn" data-retry="'+taskId+'">Reprocessar</button>';ui.btn.disabled=false;}else{setTimeout(loop,1000);}}catch(e){ui.result.textContent='Erro: '+e.message;ui.btn.disabled=false;}};loop();}function wire(form){const btn=form.querySelector('button[data-action]');const bar=form.querySelector('.progress .bar');const result=form.querySelector('.result');btn.addEventListener('click',async(e)=>{e.preventDefault();result.innerHTML='';bar.style.width='0%';btn.disabled=true;const map={split:'/api/split',merge:'/api/merge',compress:'/api/compress','pdf-to-docx':'/api/pdf-to-docx'};try{const j=await postForm(map[btn.dataset.action],form);if(!j.ok) throw new Error(j.error||'Erro');if(j.eta_seconds){result.innerHTML='Estimativa: ~'+etaText(j.eta_seconds)+' | PÃ¡ginas: '+(j.pages||'?');}if(j.path){bar.style.width='100%';const a=document.createElement('a');a.href='/download?path='+encodeURIComponent(j.path);a.className='btn';a.textContent='Baixar';result.appendChild(a);btn.disabled=false;return;}poll(j.task_id,{bar,result,btn},(path)=>{const a=document.createElement('a');a.href='/download?path='+encodeURIComponent(path);a.className='btn';a.textContent='Baixar';result.appendChild(a);btn.disabled=false;});}catch(e){result.textContent='Erro: '+e.message;btn.disabled=false;}});form.addEventListener('click',async(e)=>{const tgt=e.target.closest('[data-retry]');if(!tgt) return;e.preventDefault();const id=tgt.getAttribute('data-retry');result.textContent='Reprocessando...';const r=await fetch('/api/retry/'+id,{method:'POST'});const j=await r.json();if(j.ok){poll(j.task_id,{bar,result,btn},(path)=>{const a=document.createElement('a');a.href='/download?path='+encodeURIComponent(path);a.className='btn';a.textContent='Baixar';result.appendChild(a);btn.disabled=false;});}else{result.textContent='Erro ao reprocessar: '+(j.error||'');}});}document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('form.upload-form').forEach(wire);});})();